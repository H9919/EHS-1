<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart EHS Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f6f7fb; }
    .chat-card { max-width: 880px; margin: 24px auto; }
    .bubble { max-width: 80%; }
    .bubble.user { background:#0d6efd; color:#fff; }
    .bubble.bot { background:#f1f3f5; }
    .dim { opacity: .5; }
  </style>
</head>
<body>
  <div class="container chat-card">
    <div class="card shadow-sm">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ü§ñ</span>
        <div>
          <div class="fw-bold">Smart EHS Assistant</div>
          <div class="text-muted small">Ask about incidents, SDS, CAPAs, safety concerns‚Ä¶</div>
        </div>
      </div>

      <div id="chat-history" class="card-body" style="height:56vh; overflow-y:auto;">
        <div class="text-muted small mb-3">
          Tip: try ‚Äúreport incident‚Äù, ‚Äúfind SDS for acetone‚Äù, or ‚Äúsuggest CAPAs‚Äù.
        </div>
      </div>

      <div class="card-footer">
        <form id="chat-form" action="/chat" method="post"> <!-- non-JS fallback -->
          <div class="input-group">
            <input id="chat-input" name="message" type="text" class="form-control" placeholder="Type a message‚Ä¶" autocomplete="off">
            <button id="send-btn" class="btn btn-primary" type="submit">Send</button>
          </div>
        </form>
        <div class="mt-2">
          <button id="reset-btn" class="btn btn-outline-secondary btn-sm">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <noscript>
    <div class="container"><div class="alert alert-warning mt-3">
      JavaScript is disabled. Submitting will do a full page post to <code>/chat</code>.
    </div></div>
  </noscript>

  <script>
    // ‚Äî‚Äî‚Äî utilities
    function el(id){ return document.getElementById(id); }
    function bubble(text, who){
      const row = document.createElement('div');
      row.className = (who==='user'?'text-end':'text-start') + ' mb-2';
      const b = document.createElement('div');
      b.className = 'bubble rounded-3 p-2 d-inline-block ' + (who==='user'?'user':'bot');
      b.textContent = text;
      row.appendChild(b);
      el('chat-history').appendChild(row);
      el('chat-history').scrollTop = el('chat-history').scrollHeight;
    }

    async function postChat(message){
      // Use FormData to match the backend; it also supports JSON fallback
      const fd = new FormData();
      fd.append('message', message);
      const res = await fetch('/chat', { method:'POST', body: fd });
      if (!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }

    async function resetChat(){
      try { await fetch('/chat/reset', { method:'POST' }); } catch(e){}
      el('chat-history').innerHTML = '';
      bubble("üëã Hello! I'm your Smart EHS Assistant. How can I help?", 'bot');
    }

    // ‚Äî‚Äî‚Äî main bind
    window.addEventListener('DOMContentLoaded', () => {
      const form = el('chat-form');
      const input = el('chat-input');
      const sendBtn = el('send-btn');
      const resetBtn = el('reset-btn');

      // greet
      bubble("üëã Hello! I'm your Smart EHS Assistant. How can I help?", 'bot');

      // prevent full page post (we keep it as fallback if JS fails)
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        sendBtn.disabled = true;
        const msg = (input.value || '').trim();
        if (!msg){ sendBtn.disabled = false; return; }
        bubble(msg, 'user');
        input.value = '';
        try {
          const data = await postChat(msg);
          bubble(data.message || 'OK', 'bot');
        } catch(err){
          console.error('Chat error', err);
          bubble("I'm sorry, I'm having trouble connecting right now.", 'bot');
        } finally {
          sendBtn.disabled = false;
        }
      });

      // also send on Enter
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          sendBtn.click();
        }
      });

      // reset button
      resetBtn.addEventListener('click', resetChat);
    });
  </script>
</body>
</html>
